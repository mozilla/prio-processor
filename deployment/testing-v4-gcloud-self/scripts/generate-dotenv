#!/usr/bin/env bash
# Generate dotenv files for each of the compose configurations

set -e

PROJECT=${PROJECT:-amiyaguchi-prio-processor-v4-1}
TAG=${TAG:-mozilla/prio-processor:v3.0.0}

if [[ $(gcloud config get-value project) != "$PROJECT" ]]; then 
    echo "project is not set correctly; run 'gcloud config set project $PROJECT'"
    exit 1
fi

function get-key {
    local json=$1
    local key=$2
    echo "$json" | jq -r ".$key"
}

# reuse results from a single gsutil call
_results=$(gsutil ls)
function get-bucket {
    local pattern=$1
    path=$(echo "$_results" | grep "$pattern")
    # strip any trailing slashes
    trim="${path%/}"
    # trim gs:// prefix
    trim="${trim#gs://}"
    echo "$trim"
}

function upper {
    local text=$1
    echo "$text" | tr '[:lower:]' '[:upper:]'
}

# work from the parent directory
cd "$(dirname "$0")/.."

keys_a=$(docker run -it "$TAG" prio keygen)
keys_b=$(docker run -it "$TAG" prio keygen)
seed=$(docker run -it "$TAG" prio shared-seed)

# minio configuration
minio=$(jq -r '.' .secrets/minio-config.json)

# list out all the variables we might need...
app_name="test-app"
bucket_prefix="$app_name/v1"
data_config="/app/config/content.json"
origin_config="/app/config/telemetry_origin_data_inc.json"

function ingest-env {
    local is_template=$1
    local output;
    output=$(if [[ $is_template == true ]]; then echo .env.template; else echo .env; fi)
    cat << EOF > "compose/ingest/$output"
# This configuration is generated by scripts/generate-dotenv. Do not check in
# manually edited values into source control.
COMPOSE_PROJECT_NAME="$(basename "$(pwd)")-ingest"

APP_NAME=$app_name
DATA_CONFIG=$data_config
ORIGIN_CONFIG=$origin_config
BUCKET_PREFIX=$bucket_prefix

# relative to the docker-compose file
GOOGLE_APPLICATION_CREDENTIALS="../../.secrets/service-account-ingest-private-key.json"

PUBLIC_KEY_HEX_INTERNAL=$(get-key "$keys_a" public_key)
BUCKET_INTERNAL_INGEST=$(get-bucket a-ingest)
# The keys for the internal gateway don't particularly matter since it generally
# shouldn't be accessible over the public internet.
BUCKET_INTERNAL_ACCESS_KEY=a-access-key
BUCKET_INTERNAL_SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))")
BUCKET_INTERNAL_ENDPOINT=http://gcs-gateway-ingest:9000

PUBLIC_KEY_HEX_EXTERNAL=$(get-key "$keys_b" public_key)
BUCKET_EXTERNAL_INGEST=$(get-key "$minio" buckets.ingest)
BUCKET_EXTERNAL_ACCESS_KEY=$(get-key "$minio" keys.ingest.access_key)
BUCKET_EXTERNAL_SECRET_KEY=$(get-key "$minio" keys.ingest.secret_key)
BUCKET_EXTERNAL_ENDPOINT=http://minio-b:9000

# The ingest also gets access to the private internal bucket, because ingest and
# server A are operated by the same entity in the origin telemetry setup
BUCKET_INTERNAL_PRIVATE=$(get-bucket a-private)
DATASET=telemetry
TABLE=content_blocking
BQ_REPLACE=true
CLOUDSDK_CORE_PROJECT=$PROJECT
EOF
}

function server-internal-env {
    local server_id=$1
    local internal_key=$2
    local external_key=$3
    local is_template=$4

    local other_id;
    other_id=$(if [[ $server_id == a ]]; then echo b; else echo a; fi)
    local output;
    output=$(if [[ $is_template == true ]]; then echo .env.template; else echo .env; fi)
    cat << EOF > "compose/server-$server_id/$output"
# This configuration is generated by scripts/generate-dotenv. Do not check in
# manually edited values into source control.
COMPOSE_PROJECT_NAME="$(basename "$(pwd)")-$server_id"

APP_NAME=$app_name
DATA_CONFIG=$data_config
BUCKET_PREFIX=$bucket_prefix
SERVER_ID=$(upper "$server_id")
SHARED_SECRET=$(get-key "$seed" shared_seed)

# Used for the MinIO GCS gateway
GOOGLE_APPLICATION_CREDENTIALS="../../.secrets/service-account-$server_id-private-key.json"

PRIVATE_KEY_HEX=$(get-key "$internal_key" private_key)
PUBLIC_KEY_HEX_INTERNAL=$(get-key "$internal_key" public_key)
BUCKET_INTERNAL_INGEST=$(get-bucket "${server_id}-ingest")
BUCKET_INTERNAL_PRIVATE=$(get-bucket "${server_id}-private")
BUCKET_INTERNAL_SHARED=$(get-bucket "${server_id}-shared")
# The keys for the internal gateway don't particularly matter since it generally
# shouldn't be accessible over the public internet.
BUCKET_INTERNAL_ACCESS_KEY=$server_id-access-key
BUCKET_INTERNAL_SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))")
BUCKET_INTERNAL_ENDPOINT=http://gcs-gateway-a:9000

PUBLIC_KEY_HEX_EXTERNAL=$(get-key "$external_key" public_key)
BUCKET_EXTERNAL_SHARED=$(get-key "$minio" buckets.shared)
BUCKET_EXTERNAL_ACCESS_KEY=$(get-key "$minio" keys.external.access_key)
BUCKET_EXTERNAL_SECRET_KEY=$(get-key "$minio" keys.external.secret_key)
BUCKET_EXTERNAL_ENDPOINT=http://minio-b:9000
EOF
}

function server-external-env {
    local server_id=$1
    local internal_key=$2
    local external_key=$3
    local is_template=$4

    local other_id;
    other_id=$(if [[ $server_id == a ]]; then echo b; else echo a; fi)
    local output;
    output=$(if [[ $is_template == true ]]; then echo .env.template; else echo .env; fi)
    cat << EOF > "compose/server-$server_id/$output"
# This configuration is generated by scripts/generate-dotenv. Do not check in
# manually edited values into source control.
COMPOSE_PROJECT_NAME="$(basename "$(pwd)")-$server_id"

APP_NAME=$app_name
DATA_CONFIG=$data_config
BUCKET_PREFIX=$bucket_prefix
SERVER_ID=$(upper "$server_id")
SHARED_SECRET=$(get-key "$seed" shared_seed)

# Used for the MinIO GCS gateway
GOOGLE_APPLICATION_CREDENTIALS="../../.secrets/service-account-$server_id-private-key.json"

PRIVATE_KEY_HEX=$(get-key "$internal_key" private_key)
PUBLIC_KEY_HEX_INTERNAL=$(get-key "$internal_key" public_key)
BUCKET_INTERNAL_INGEST=$(get-key "$minio" buckets.ingest)
BUCKET_INTERNAL_PRIVATE=$(get-key "$minio" buckets.private)
BUCKET_INTERNAL_SHARED=$(get-key "$minio" buckets.shared)
BUCKET_INTERNAL_ACCESS_KEY=$(get-key "$minio" keys.internal.access_key)
BUCKET_INTERNAL_SECRET_KEY=$(get-key "$minio" keys.internal.secret_key)
BUCKET_INTERNAL_ENDPOINT=http://minio-b:9000

# access to the external bucket is mediated by the gcs gateway, use the same
# internal keys for gcs-gateway as for access to the normal minio instance.
PUBLIC_KEY_HEX_EXTERNAL=$(get-key "$external_key" public_key)
BUCKET_EXTERNAL_SHARED=$(get-bucket "${other_id}-shared")
BUCKET_EXTERNAL_ACCESS_KEY=$(get-key "$minio" keys.internal.access_key)
BUCKET_EXTERNAL_SECRET_KEY=$(get-key "$minio" keys.internal.secret_key)
BUCKET_EXTERNAL_ENDPOINT=http://gcs-gateway-b:9000
EOF
}

ingest-env true
ingest-env false
server-internal-env a "$keys_a" "$keys_b" true
server-internal-env a "$keys_a" "$keys_b" false
server-external-env b "$keys_b" "$keys_a" true
server-external-env b "$keys_b" "$keys_a" false
